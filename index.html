<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pull Box Data</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Pull Data</h1>

  <canvas id="halfHourChart" width="500" height="200"></canvas>

  <script>
    // Load JSON data
    let halfHourData = {};
    fetch('data/data.json')
      .then(response => response.json())
      .then(
      
      data => {
        console.log(data);
        let numericData = data.map(d => {
          // Parse timestamp and convert to EST
          const date = new Date(d.timestamp);          
          // Round to nearest half hour
          const minutes = date.getMinutes();
          date.setMinutes(minutes < 30 ? 0 : 30, 0, 0);
          
          return {
            date: date.toLocaleDateString('en-US',{
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
             }),
            timestamp: date.toLocaleString('en-US', { 
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                      }),
            pull_value: parseFloat(d.pull_value),
            online_value: parseInt(d.online_value, 10),
            ratio: parseFloat(d.ratio)
          };
        });
        
        // Half hour data aggregation
        numericData.forEach(d => {
          const key = d.timestamp;
          if (!halfHourData[key]) {
            halfHourData[key] = { pull_sum: 0, online_sum: 0, ratio_sum: 0, count: 0 };
          }
          halfHourData[key].pull_sum += d.pull_value;
          halfHourData[key].online_sum += d.online_value;
          halfHourData[key].ratio_sum += d.ratio;
          halfHourData[key].count += 1;
        })
        console.log(numericData);
        
        // Generate all 24-hour half-hour labels
        const labels = [];
        for (let hour = 0; hour < 24; hour++) {
          labels.push(`${String(hour).padStart(2, '0')}:00`);
          labels.push(`${String(hour).padStart(2, '0')}:30`);
        }
        
        console.log(labels);
        console.log(halfHourData);
        const pullValues = labels.map(label => halfHourData[label]?.pull_sum || 0);
        const onlineValues = labels.map(label => halfHourData[label]?.online_sum || 0);
        const ratioValues = labels.map(label => halfHourData[label] ? halfHourData[label].ratio_sum / halfHourData[label].count : 0);
        console.log(ratioValues)
          // Create Pull Chart
        const halfHourChart = new Chart(document.getElementById('halfHourChart'), {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Expected pull value',
                data: ratioValues,
                borderColor: 'blue',
                fill: false
              }]
            },
            options: {
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
      });
  </script>
</body>
</html>

