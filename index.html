<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pull Box Data</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Pull Data</h1>

  <canvas id="halfHourChart" width="500" height="200"></canvas>
  <canvas id="weeklyChart" width="500" height="200"></canvas>

  <script>
    function createChart(chartID, data,labels){
      
      const pullValues = labels.map(label => data[label]?.pull_sum || 0);
        const onlineValues = labels.map(label => data[label]?.online_sum || 0);
        const ratioValues = labels.map(label => data[label] ? data[label].ratio_sum / data[label].count : 0);
        console.log(ratioValues)
        const newChart = new Chart(document.getElementById(chartID), {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Expected pull value',
                data: ratioValues,
                borderColor: 'blue',
                fill: false
              }]
            },
            options: {
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
          return newChart
    }
    // Load JSON data
    let halfHourData = {};
    let weeklyData = {};
    fetch('data/data.json')
      .then(response => response.json())
      .then(
      
      data => {
        console.log(data);
        let numericData = data.map(d => {
          // Parse timestamp and convert to EST
          const date = new Date(d.timestamp);          
          // Round up to nearest half hour
          const minutes = date.getMinutes();
          if (minutes > 0 && minutes <= 30) {
            date.setMinutes(30, 0, 0);
          } else if (minutes > 30) {
            date.setMinutes(0, 0, 0);
            date.setHours(date.getHours() + 1);
          } else {
            date.setMinutes(0, 0, 0);
          }
          
          return {
            date: date.toLocaleDateString('en-US',{
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
             }),
            timestamp: date.toLocaleString('en-US', { 
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                      }),
            pull_value: parseFloat(d.pull_value),
            online_value: parseInt(d.online_value, 10),
            ratio: parseFloat(d.ratio)
          };
        });
        const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        // Half hour data aggregation
        numericData.forEach(d => {
          const hourlyKey = d.timestamp;
          if (!halfHourData[hourlyKey]) {
            halfHourData[hourlyKey] = { pull_sum: 0, online_sum: 0, ratio_sum: 0, count: 0 };
          }
          halfHourData[hourlyKey].pull_sum += d.pull_value;
          halfHourData[hourlyKey].online_sum += d.online_value;
          halfHourData[hourlyKey].ratio_sum += d.ratio;
          halfHourData[hourlyKey].count += 1;
          const weeklyKey = new Date(d.date).getDay();
          const weekday = weekdayNames[weeklyKey];
          if (!weeklyData[weekday]) {
            weeklyData[weekday] = { pull_sum: 0, online_sum: 0, ratio_sum: 0, count: 0 };
          }
          weeklyData[weekday].pull_sum += d.pull_value;
          weeklyData[weekday].online_sum += d.online_value;
          weeklyData[weekday].ratio_sum += d.ratio;
          weeklyData[weekday].count += 1;
        })
        //console.log(numericData);
        
        // Generate all 24-hour half-hour labels
        const hourlyLabels = [];
        for (let hour = 0; hour < 24; hour++) {
          hourlyLabels.push(`${String(hour).padStart(2, '0')}:00`);
          hourlyLabels.push(`${String(hour).padStart(2, '0')}:30`);
        }


        let hourChart = createChart('halfHourChart', halfHourData, hourlyLabels);
        let weeklyChart = createChart('weeklyChart', weeklyData, weekdayNames);
        //console.log(labels);
        //console.log(halfHourData);
        
      });
  </script>
</body>
</html>

